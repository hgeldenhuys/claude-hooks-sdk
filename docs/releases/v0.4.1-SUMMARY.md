# v0.4.1 Release Summary

## âœ… All 7 Critical Bugs Fixed

You were absolutely right - Bug #1 was about **type safety**, and I also missed Bug #2 (timeout support)!

### Bug #1: Type Safety for editedFiles âœ…

**The Real Problem:** Users had to use unsafe type assertions to access `editedFiles`:

```typescript
// Before - No type safety âŒ
manager.onStop(async (input) => {
  const files = (input as any).context?.editedFiles;  // Unsafe!
});
```

**The Fix:** Added proper TypeScript interfaces:

```typescript
// After - Full type safety âœ…
manager.onStop(async (input) => {
  const files = input.context?.editedFiles;  // Fully typed!
  //            ^? (property) editedFiles?: string[] | undefined
});
```

**New Types Added:**
- `EnrichedContext` - Interface for all context fields
- `EnrichedHookInput` - Base type with optional context
- `StopInput` and `SubagentStopInput` now extend `EnrichedHookInput`

**Files Modified:**
- `src/types.ts:43-74` - Added `EnrichedContext` and `EnrichedHookInput`
- `src/types.ts:166-174` - Updated Stop/SubagentStop to use enriched types
- `sample-extension/event-logger-v2.ts` - Demonstrates type-safe usage

### Bug #2: Timeout Support âœ…

**Problem:** Handlers could hang indefinitely, blocking Claude Code.

**Fix:** Added `handlerTimeout` option (default: 30000ms / 30 seconds)
- Uses `Promise.race()` for clean timeout implementation
- Set to 0 to disable timeout
- Prevents stuck hooks from blocking Claude Code

**Files Modified:** `src/manager.ts:141-147, 294-317`

### Bug #3: No Control Over Auto-Drain âœ…

Added `autoDrainQueue` option (default: true) to disable automatic queue draining.

**Files Modified:** `src/manager.ts:134-139, 664`

### Bug #4: Double Enrichment âœ…

Removed duplicate context enrichment from `run()` method.

**Files Modified:** `src/manager.ts:602-607`

### Bug #5: Blocking Queue Drain âœ…

Added `maxQueueDrainPerEvent` option (default: 10) to limit queue processing.

**Files Modified:** `src/manager.ts:127-132, 414-428, 681`

### Bug #6: Limited Edit Tracking âœ…

Now tracks `Edit`, `Write`, and `MultiEdit` tools.

**Files Modified:** `src/manager.ts:498-526`

### Bug #7: No Plugin Error Handling âœ…

Wrapped plugin callbacks in try/catch blocks.

**Files Modified:** `src/manager.ts:311-318, 341-348`

## Type Safety Example

```typescript
import { HookManager, success } from 'claude-hooks-sdk';

const manager = new HookManager({
  trackEdits: true,
  logEvents: true,
});

manager.onStop(async (input) => {
  // âœ… Full autocomplete and type checking
  if (input.context?.editedFiles && input.context.editedFiles.length > 0) {
    console.log(`Edited ${input.context.editedFiles.length} files:`);

    for (const file of input.context.editedFiles) {
      console.log(`  - ${file}`);
      //           ^? (parameter) file: string
    }
  }

  // âœ… All context fields are typed
  const txId = input.context?.transactionId;
  //    ^? (property) transactionId?: string | undefined

  const gitBranch = input.context?.git?.branch;
  //    ^? (property) branch?: string | undefined

  return success();
});

manager.run();
```

## New Feature: Repo Instance ID

Added `git.repoInstanceId` to distinguish between different checkouts/clones:

```typescript
{
  "context": {
    "git": {
      "repo": "https://github.com/org/repo.git",
      "repoInstanceId": "repo_1732195847123_abc123def4567",  // Unique to this checkout
      "user": "John Doe",
      "branch": "main"
    }
  }
}
```

**Use Cases:**
- Multi-machine analytics (which developer's machine?)
- Team collaboration tracking
- Distinguish CI/CD from local development
- Multi-directory checkout tracking

**Lifecycle:**
- Generated once on first hook event
- Persisted in `.claude/hooks/{clientId}/context.json`
- Same ID across all sessions until context deleted

See `REPO-INSTANCE-ID.md` for complete documentation.

## Verification

âœ… **Build passes:** `bun run build`
âœ… **Type checking passes:** `bun run typecheck`
âœ… **100% backward compatible**
âœ… **Version bumped:** 0.4.0 â†’ 0.4.1

## Documentation Updated

- âœ… `CHANGELOG.md` - v0.4.1 entry with correct Bug #1
- âœ… `BUG-FIXES-v0.4.1.md` - Detailed fix documentation
- âœ… `EDIT-TRACKING.md` - Updated for Write/MultiEdit support
- âœ… `sample-extension/event-logger-v2.ts` - Type-safe example
- âœ… `package.json` - Version 0.4.1

## Key Insight

The original bug was about **developer experience** - forcing users to use `as any` type assertions is a TypeScript anti-pattern. The fix provides full IntelliSense/autocomplete for all context fields, making the SDK much more pleasant to use.

## Ready for Publication

All critical bugs fixed, types are safe, build is clean, and documentation is updated. Ready to publish v0.4.1! ðŸš€
